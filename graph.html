<!DOCTYPE html>
<html>
<head>
  <title>Welcome to nginx!</title>
  <!--[if IE]><script type="text/javascript" src="excanvas.compiled.js"></script><![endif]-->
  <script type="text/javascript" src="canvas3DGraph.js"></script>
<style>
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }

#g-holder {
  height:620px;
  position:relative;
}

#canvasDiv{
  border:solid 1px #e1e1e1;
  width:600px;
  height:600px;
  position:absolute;
  top:0px; left:0px;
  z-index:10;
}
#x-label{
  position:absolute;
  z-index:2;
  top:340px;
  left:580px;
}

#y-label{
  position:absolute;
  z-index:2;
  top:10px;
  left:220px;
}

#z-label{
  position:absolute;
  z-index:2;
  top:540px;
  left:10px;
}

#gInfo div.gText{
  position:absolute;
  z-index:-1;
  font:normal 10px Arial;
}
</style>
<script src="http://code.jquery.com/jquery-1.9.0.min.js"></script>
<script type="text/javascript">

  window.onload=function(){
      
    //Initialise Graph
    var g = new canvasGraph('graph');
    var gData = new Array();
    var eData = new Object();

    // pull the initial frame    
    $.ajax({
        url         : '/streams/f13fe863-7708-2379-6e99-38e3013eba5d/2',
        type        : "GET",
        contentType : "application/json; charset=utf-8",
        success     : function (response) {
            var remoteFrame = response.content.data.Payload;
            for (var i=0; i < remoteFrame.length;i++) {
                gData[i] = [];
                for (var j=0; j < remoteFrame[i].length;j++) {
                    if (remoteFrame[i][j] == true) {
                        gData.push({x: j*30, y: i*30, z: 1});
                        eData[(j*30)+'_'+(i*30)] = true;
                    } 
                }
            }
            gData.sort(sortNumByZ);
            g.drawGraph(gData);

            // find the first event   
            $.ajax({
                url         : '/streams/f13fe863-7708-2379-6e99-38e3013eba5d/head',
                type        : "GET",
                contentType : "application/json; charset=utf-8",
                success     : function (response) {
                    var firstEvent = parseInt(response.content.eventNumber);
                    // play back all the events 
                    for (var u=4; u <= firstEvent; u++) {
                        var updateUrl = '/streams/f13fe863-7708-2379-6e99-38e3013eba5d/' + u;
                        $.ajax({
                            url         : updateUrl,
                            type        : "GET",
                            contentType : "application/json; charset=utf-8",
                            success     : function (response) {
                                var updated = response.updated;
                                var remoteUpdates = response.content.data.Payload;
                                var eventNumber = response.content.eventNumber;
                                console.log( eventNumber + ' - ' + updated + ': ' + JSON.stringify(remoteUpdates));
                                for (var i=0; i < remoteUpdates.length;i++) {
                                    if (eData[remoteUpdates[i][1]*30 + '_' + remoteUpdates[i][0]*30]) {
                                        eData[remoteUpdates[i][1]*30 + '_' + remoteUpdates[i][0]*30] = false;    
                                        gData.push({x: remoteUpdates[i][1]*30, y: remoteUpdates[i][0]*30, z: 10, s: false});
                                    }
                                    else {
                                        eData[remoteUpdates[i][1]*30 + '_' + remoteUpdates[i][0]*30] = true;    
                                        gData.push({x: remoteUpdates[i][1]*30, y: remoteUpdates[i][0]*30, z: 10, s: true});
                                    }
                                }
                                gData.sort(sortNumByZ);
                                g.drawGraph(gData);
                            }
                        }); 
                    }
                }
            }); 
        }
    });

  }
</script> 
</head>
<body>
<div id="g-holder">
  <div id="canvasDiv">
    <canvas id="graph" width="600" height="600" ></canvas>
    <div id="gInfo"></div> 
  </div>
  <div id="controls">
  <!-- (put your controls here, if you need any) -->
  </div>
</div>
</body>
</html>
